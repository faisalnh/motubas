# Motubas - Project Context for Claude Code

## Project Overview
Motubas is a digital service record book web application for old cars (5+ years) in Indonesia. Freemium model with MVP targeting Indonesian market (Mobil Tua Bangka segment).

**Primary Language:** Bahasa Indonesia (UI) / English (Code/System)

## Tech Stack (2025 Latest Versions)
- **Framework:** Next.js 15.1.4 (App Router with Turbopack)
- **Language:** TypeScript 5.7+
- **Database:** PostgreSQL with Prisma 7.1.0 (Rust-free, with PG adapter)
- **Authentication:** Auth.js v5 (NextAuth.js v5 beta)
- **AI:** Google Gemini 2.5 Flash API (@google/genai ^1.34.0)
- **UI:** Tailwind CSS + shadcn/ui
- **File Storage:** Vercel Blob Storage
- **Forms:** React Hook Form + Zod validation
- **State:** React Query (@tanstack/react-query)
- **Image Compression:** browser-image-compression (client-side, max 1MB)

## Important Commands

### Development
```bash
npm run dev              # Start dev server with Turbopack
npm run build            # Production build
npm run lint             # Run ESLint
```

### Database (Prisma)
```bash
npx prisma generate      # Generate Prisma client (run after schema changes)
npx prisma migrate dev   # Create and apply migration
npx prisma migrate reset # Reset database (WARNING: deletes all data)
npx prisma studio        # Open database GUI at localhost:5555
npx prisma db push       # Push schema without migration (dev only)
```

### Deployment
```bash
vercel                   # Deploy to preview
vercel --prod            # Deploy to production
vercel env pull          # Pull environment variables
```

## Code Style Guidelines

### IMPORTANT: Always follow these rules

1. **Use Server Components by default** - Only add 'use client' when needed (forms, hooks, browser APIs)
2. **Database queries in Server Components** - Never fetch data in Client Components
3. **Server Actions for mutations** - Place in `app/actions/` directory
4. **Indonesian UI labels** - All user-facing text must be in Bahasa Indonesia
5. **Type safety** - Use Zod for validation, leverage Prisma types
6. **Error handling** - Always return `{ error: string }` or `{ success: true }` from Server Actions

### File Organization
```
app/
  (auth)/           # Public auth pages (login, register)
  (dashboard)/      # Protected pages with layout
  api/              # API routes
  actions/          # Server actions
components/
  ui/               # shadcn/ui components only
lib/                # Utility functions, DB client, helpers
prisma/             # Database schema and migrations
```

### Naming Conventions
- **Components:** PascalCase (`CarCard.tsx`)
- **Server Actions:** camelCase in files (`auth.ts` exports `login`, `register`)
- **Database:** snake_case tables, camelCase in Prisma schema
- **API routes:** REST-ful (`/api/cars`, `/api/cars/[id]`)

## Core Files Reference

### Database & Auth
- `lib/db.ts` - Prisma client with PG adapter (singleton pattern)
- `auth.ts` - Auth.js configuration with session/jwt callbacks
- `auth.config.ts` - Provider configuration (Google OAuth + Credentials)
- `middleware.ts` - Route protection (redirect logic)

### Utilities
- `lib/utils.ts` - cn() for Tailwind, formatCurrency, formatDate (Indonesian locale)
- `lib/subscription.ts` - Freemium tier logic (canAddCar, canUseAI, etc.)
- `lib/reminder-calculator.ts` - Maintenance reminder intervals and due date calculations

### Schema
- `prisma/schema.prisma` - Complete database schema with all relationships

## Freemium Business Logic

**CRITICAL:** Always enforce these limits for FREE tier:
- Max 1 car (check in `canAddCar()` before allowing car creation)
- 10 AI credits per month (check `aiCreditsRemaining` before AI queries)
- No email/push notifications (check `subscriptionTier` before sending)

## Database Schema Key Points

### User Flow
1. User signs up â†’ FREE tier, 10 AI credits
2. User adds car â†’ Max 1 for FREE (check `subscriptionTier`)
3. User adds service â†’ Creates auto reminders based on service type
4. Service with cost â†’ Invoice photo REQUIRED (except self-service)

### Important Fields
- `service_records.entryCreatedAt` - Original entry time (for backdating transparency)
- `service_records.createdAt/updatedAt` - System timestamps (show both to users)
- `cars.isPrimary` - Always true for FREE tier (only 1 car allowed)
- `maintenance_reminders.isNotified` - Only true for PREMIUM tier

### Enums
```typescript
ServiceType: OIL_CHANGE | BRAKE_SERVICE | TIRE_ROTATION | ENGINE_CHECK | TRANSMISSION | GENERAL_SERVICE | CUSTOM
ReminderType: OIL_CHANGE | BRAKE_FLUID | COOLANT | TRANSMISSION_FLUID | TIRE_ROTATION | AIR_FILTER | SPARK_PLUG | TIMING_BELT
SubscriptionTier: FREE | PREMIUM
```

## Testing Workflow

### Before Committing
1. âœ… Run `npm run lint` - Fix all linting errors
2. âœ… Check Prisma schema - Run `npx prisma format` and `npx prisma validate`
3. âœ… Test authentication flow - Login, register, OAuth
4. âœ… Test free tier limits - Try adding 2nd car (should fail)

### Local Testing Database
- Use Vercel Postgres preview branch or local PostgreSQL
- Never test migrations on production database
- Run `npx prisma migrate reset` to start fresh if needed

## Common Tasks

### Adding a New Page
1. Create in `app/(dashboard)/[page]/page.tsx`
2. Add to navbar in `components/navbar.tsx`
3. Use Server Component for data fetching
4. Add Bahasa Indonesia labels

### Adding a Form
1. Create Server Action in `app/actions/`
2. Use Zod schema for validation
3. Return `{ error: string }` or `{ success: true }`
4. Use `'use client'` component with `useFormStatus` hook
5. Show Indonesian error messages

### Adding UI Component
1. Check if shadcn/ui has it: https://ui.shadcn.com
2. If yes: Copy component to `components/ui/`
3. If no: Create custom component with Tailwind
4. Use `cn()` from lib/utils for conditional classes

## Environment Variables Required

```bash
DATABASE_URL              # PostgreSQL connection string
AUTH_SECRET               # Generate with: openssl rand -base64 32
AUTH_URL                  # http://localhost:3000 (dev) or production domain
AUTH_GOOGLE_ID            # Google OAuth Client ID
AUTH_GOOGLE_SECRET        # Google OAuth Client Secret
GEMINI_API_KEY            # Google Gemini API key from AI Studio
BLOB_READ_WRITE_TOKEN     # Vercel Blob storage token
```

## Gotchas & Important Notes

### Prisma with Vercel Postgres
- **MUST use PG adapter** - See `lib/db.ts` for implementation
- Pool connection required for serverless
- Run `prisma generate` after schema changes

### Auth.js v5 Breaking Changes
- Use `auth()` function, not `getServerSession()`
- Middleware uses `auth()` callback, not `withAuth()`
- Session strategy must be 'jwt' for serverless

### Image Upload Flow
1. Client-side compress to max 1MB (browser-image-compression)
2. Upload to Vercel Blob
3. Store URL in database
4. Validation: Invoice required if serviceCost exists AND NOT self-service

### Indonesian Locale
- Currency: `Rp 50.000` (no decimals for IDR)
- Date: `31 Desember 2025` (long format)
- Numbers: `1.000.000` (dot separator for thousands)

## MVP Feature Checklist

**Completed âœ…:**
- Project setup with Next.js 15
- Database schema with Prisma 7
- Authentication (Email + Google OAuth)
- Dashboard layout and navigation
- Landing page

**TODO ðŸš§:**
- [ ] Car management (add/edit with FREE tier limit)
- [ ] Service record CRUD with invoice upload
- [ ] Maintenance reminders system
- [ ] Om Motu AI chat with Gemini Flash
- [ ] Dashboard analytics with charts
- [ ] Profile page

## Deployment Notes

### Vercel Setup
1. Connect GitHub repo
2. Add all environment variables
3. Enable Vercel Postgres
4. Update Google OAuth redirect URI to production domain
5. Deploy

### Post-Deployment
- Test OAuth callback URL
- Verify database migrations applied
- Check Blob storage working
- Test free tier limits in production

## Support Resources

- Next.js 15: https://nextjs.org/docs
- Prisma 7: https://www.prisma.io/docs
- Auth.js v5: https://authjs.dev
- Gemini API: https://ai.google.dev/gemini-api/docs
- shadcn/ui: https://ui.shadcn.com

---

## Skills Architecture

This project uses **Agent Skills** for domain-specific knowledge. Skills are stored in subdirectories with `SKILL.md` files that provide focused, reusable instructions.

### When to Create a SKILL.md

Create Skills for:
- **Domain-specific workflows** (e.g., car service record processing)
- **Complex multi-step processes** (e.g., invoice upload with compression)
- **Reusable patterns** (e.g., Prisma queries for analytics)
- **Integration guides** (e.g., Gemini AI chat implementation)

### Skill Structure Guidelines

Each `SKILL.md` must have YAML frontmatter:
```yaml
---
name: skill-name-here  # lowercase, hyphens only, max 64 chars
description: What it does and when to use it (max 1024 chars, third person)
---
```

**Best Practices:**
- Keep SKILL.md under 500 lines
- Use progressive disclosure (link to reference files for details)
- Include concrete examples with input/output pairs
- Test with actual usage before expanding content
- Use third person in descriptions ("Processes files..." not "I can process...")
- Files referenced should be one level deep from SKILL.md
- Use forward slashes in paths (not backslashes)
- Provide utility scripts for deterministic operations

### Current Skills

- `skills/prisma/` - Database query patterns and Prisma best practices
- `skills/service-records/` - Service record workflows with invoice handling
- `skills/ai-assistant/` - Gemini Flash integration and Om Motu AI patterns

See individual SKILL.md files in each directory for detailed instructions.

---

**Last Updated:** 2025-12-31
**Project Status:** MVP Development Phase
**Target Launch:** Q1 2026
